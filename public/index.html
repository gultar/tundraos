<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css" type="text/css"/>
    <link rel="stylesheet" href="./css/topnav.css" type="text/css"/>
    <link rel="stylesheet" href="./css/external/jquery-ui.min.js">
    <link rel="stylesheet" href="./css/external/jquery-ui.structure.min.css">
    <link rel="stylesheet" href="./css/external/jquery-ui.theme.min.css">
    <link rel="stylesheet" href="./css/external/jquery.contextMenu.min.css">
    <script src="./js/external/winbox.bundle.min.js"></script>
    <script src="https://unpkg.com/vanilla-context-menu@1.4.1/dist/vanilla-context-menu.js"></script>
    <script src="./js/external/jquery-2.1.1.min.js"></script>
    <script src="./js/external/jquery.contextMenu.min.js"></script>
    <script  src="./js/external/jquery-ui.min.js"></script>
    <script src="./js/external/boxicons.js"></script>
    <script src="./js/external/ace.min.js"></script>
    <script src="./js/external/webamp.bundle.js"></script>
    <script src="./js/filesystem/virtualfilesystem.js"></script>
    <script src="./js/applications/browser.js"></script>
    <script src="./js/applications/browser-history.js" ></script>
    <script src="./js/commands/web-cmds.js"></script>
    <script src="./js/commands/settings.js"></script>
    <script src="./js/applications/webamp.js"></script>
    <script src="./js/terminal.js"></script>
    <script src="./js/terminal-window-init.js"></script>
    <script src="./js/applications/editor.js"></script>
    <script src="./js/file-explorer/open-file.js"></script>
    <script src="./js/file-explorer/view-image.js"></script>
    <script src="./js/file-explorer/explore.js"></script>
    <script src="./js/filesystem-init.js"></script>
    <script src="./js/cmd-runner.js"></script>
    <script src="./js/applications/weather.js"></script>
    <script src="./js/external/particles.min.js"></script>
    <script src="./js/particlejs-init.js"></script>
    <script src="./js/init-script.js" defer></script>
    <script src="./js/context-menu/desktop-menu.js"></script>
    <script src="./js/window-manager/create-window.js"></script> 

    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
    <title>Document</title>
</head>
<body>
    <script>
        const getUsername = () =>{
            //Probably useless
            if(window.location.hostname == 'localhost'){
                const [ url, searchParams ] = window.location.href.split("?")
                const [ tokenAndValue, usernameAndValue ] = searchParams.split("&")
                let [ usernameLabel, value ] = usernameAndValue.split("=")
                value = value.replace("#", '')
                return value
            }else{
                return 'guest'
            }
            
        }



        const logout = async () =>{
            
            
            const [ url, searchParams ] = window.location.href.split("?")
            const username = getUsername()
            window.location.href = url
            
            if(window.location.hostname == 'localhost'){
                const loggedOut = await Promise.resolve($.post("/logout", {
                    logout:true,
                    username:username
                }))
            }

        }

        const reboot = () =>{
            $("#dialog-message").html(`<span>Are you sure you want to reboot?</span>`)
            $( "#dialog-message" ).dialog({
                resizable: false,
                height: "auto",
                width: 400,
                modal: true,
                buttons: {
                    Yes: function() {
                        $( this ).dialog( "close" );
                        window.openWindows = {}
                        if(location.hostname === 'localhost')
                            location.href = location.origin
                        else
                            location.reload()
                    },
                    No: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        }

        const shutdown = () =>{
            $("#dialog-message").html(`<span>Are you sure you want to shutdown?</span>`)
            $( "#dialog-message" ).dialog({
                resizable: false,
                height: "auto",
                width: 400,
                modal: true,
                buttons: {
                    Yes: function() {
                        $( this ).dialog( "close" );
                        window.openWindows = {}
                        window.close()
                    },
                    No: function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
        }
    </script>
    <div id="page-wrapper" class="flex">
        <div id="color-focus"></div>
        <nav id="topnav">
            <ul >
                <li class="nav-item-group">
                    <li><a href="#" >Menu</a>
                        <ul>
                            <li><a href="#" onClick="createTerminalWindow()"><img class="main-menu-icons" src="./images/icons/terminal.png" />Console</a></li>
                            <li><a href="#"><img class="main-menu-icons" src="./images/icons/settings.png" />Settings</a></li>
                            <li><a href="#" onClick="makeFileExplorer()"><img class="main-menu-icons" src="./images/icons/file-explorer.png" />Explorer</a></li>
                            <li><a href="#"><img class="main-menu-icons" src="./images/icons/internet.png" />Apps</a>
                            <ul>
                                <li><a href="#"><img class="main-menu-icons" src="./images/icons/music.png" />Music</a>
                                    <ul>
                                        <li>
                                            <a onclick="runWebamp()"><img class="main-menu-icons" src="./images/icons/winamp.png" />Webamp</a>
                                        </li>
                                        <li><a onclick='runLofi()'><img class="main-menu-icons" src="./images/icons/music.png" />Lo-fi Girl</a></li>
                                    </ul>
                                </li>
                                <li><a href="#"><img class="main-menu-icons" src="./images/icons/games.png" />Games</a>
                                    <ul>
                                        <li><a onclick="runWeb(['https://d07riv.github.io/diabloweb/'])"><img class="main-menu-icons" src="./images/diablo.png" />Diablo Web</a></li>
                                        <li><a onclick="runTirex()"><img class="main-menu-icons" src="./images/icons/Lonelytrex.webp" />Tirex Game</a></li>
                                        <li><a onclick="runWeb(['https://gba.js.org/'])"><img class="main-menu-icons" src="./images/icons/games.png" />Game Boy Advance</a></li>
                                        <li><a onclick="runWeb(['https://browserquest.io/'])"><img class="main-menu-icons" src="./images/icons/games.png" />BrowserQuest</a></li>
                                    </ul>
                                </li>
                                <li><a href="#"><img class="main-menu-icons" src="./images/icons/browser.png" />Browser</a>
                                    <ul>
                                        <li><a onclick='runWeb(["https://www.google.com/webhp?igu=1"])'><img class="main-menu-icons" src="./images/icons/google.png" />Google</a></li>
                                        <li><a onclick="runLinguee([])"><img class="main-menu-icons" src="./images/icons/translation.png" />Linguee</a></li>
                                        <li><a onclick="runWeb(['https://gdt.oqlf.gouv.qc.ca/Resultat.aspx'])"><img class="main-menu-icons" src="./images/icons/dictionary.png" />GDT</a></li>
                                        <li><a onclick='runWeb(["https://wikipedia.org"])'><img class="main-menu-icons" src="./images/icons/wikipedia.png" />Wiki</a></li>
                                        <li><a onclick='runWeb(["https://gultar.github.io/iching/"])'><img class="main-menu-icons" src="./images/icons/yinyang.png" />I-Ching</a></li>
                                        <li><a onclick='runWeb(["https://georatio.com/"])'><img class="main-menu-icons" src="./images/icons/constellation.png" />Georatio</a></li>
                                        
                                    </ul>
                                </li>
                            </ul>
                            </li>
                            <li><a href="#"><img class="main-menu-icons" src="./images/icons/system.png" />System</a>
                                <ul>
                                    <li><a onclick="logout()">Logout</a></li>
                                    <li><a onclick="reboot()">Reboot</a></li>
                                    <li><a onclick="shutdown()">Shutdown</a></li>
                                </ul>
                            </li>
                        </ul>
                        </li>
                </li>
            </ul>
            <li class="clock-container">
                <span id="clock">
                </span>
            </li>
        </nav>

        <div id="page-anchor"></div>
        <div id="filemanager"></div>

        <div id="webamp"></div>
        <div id="main-container">
            <div id="logo-container"> 
                <img id="desktop-logo" src="./images/icons/constellation-3.png">
            </div>
            <canvas class="background"></canvas>
        </div>
        <div id="browser-view" style="width:80%; height:80%;">
            
        </div>
        <div id="dialog-message" title="System Message">
            
        </div>
    </div>
    <script type="text/javascript">
        $('#page-wrapper').on('click', function(e){
                    console.log('clicked', this);
        }) 

        makeDesktopMenu()

        const popup = (...text) =>{
            $("#dialog-message").html(...text)
            $( "#dialog-message" ).dialog();
        }

        function disableF5(e) { if ((e.which || e.keyCode) == 116) e.preventDefault(); };
        
        //Forces user to "reboot" instead of refreshing
        $(document).ready(function(){
             $(document).on("keydown", (e)=>{
                disableF5(e)
             });
        });

        //prevent dragging start menu elements
        $("nav a").on('dragstart drop', function(e){
            console.log('STOP DRAG')
            e.preventDefault();
            return false;
        });

        // window.onbeforeunload = ()=>{
        //     console.log('Save state')
        //     saveWindowState()
        // }

        // setTimeout(()=>{
        //     loadWindowState()
        // }, 200)
    </script>

</body>
</html>

